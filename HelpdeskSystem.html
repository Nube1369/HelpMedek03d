<!DOCTYPE html>
<html lang="th" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Helpdesk System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts (Inter & Sarabun) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --bs-body-font-family: 'Inter', 'Sarabun', sans-serif;
            --bs-primary-rgb: 59, 130, 246;
            --bs-body-bg: #111827;
            --bs-tertiary-bg: #1f2937;
            --bs-border-color: rgba(255, 255, 255, 0.1);
        }
        body { background-color: var(--bs-body-bg); color: #d1d5db; }
        .navbar { background-color: var(--bs-tertiary-bg); border-bottom: 1px solid var(--bs-border-color); }
        .main-container { max-width: 1200px; margin-top: 2rem; margin-bottom: 2rem; }
        .card { background-color: var(--bs-tertiary-bg); border: 1px solid var(--bs-border-color); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .card-header { background-color: rgba(59, 130, 246, 0.1); color: #eff6ff; font-weight: 500; border-bottom: 1px solid var(--bs-border-color); }
        .form-control, .form-select { background-color: #374151; color: #d1d5db; border-color: #4b5563; }
        .form-control:focus, .form-select:focus { background-color: #4b5563; color: #f9fafb; border-color: #3b82f6; box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
        .form-control::placeholder { color: #9ca3af; }
        .ticket-id { font-weight: 700; color: #60a5fa; font-size: 1.1rem; }
        .status-badge.bg-warning { background-color: #f59e0b !important; color: #1f2937 !important; }
        .status-badge.bg-success { background-color: #10b981 !important; color: #ffffff !important; }
        .ticket-details strong { color: #e5e7eb; min-width: 120px; display: inline-block; }
        .ticket-footer { color: #9ca3af; }
        .loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1060; }
        .modal-content { background-color: var(--bs-tertiary-bg); border: 1px solid var(--bs-border-color); }
        #admin-dashboard { display: none; }
        .admin-nav { background-color: #1f2937; padding: 0.5rem 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .admin-nav .nav-link { color: #d1d5db; }
        .admin-nav .nav-link.active { color: #ffffff; background-color: #3b82f6; }
    </style>
</head>
<body>

    <!-- Main Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#"><i class="bi bi-headset"></i> IT Helpdesk System</a>
            <div class="ms-auto">
                 <button id="login-btn" class="btn btn-outline-primary">เจ้าหน้าที่</button>
                 <button id="logout-btn" class="btn btn-outline-danger" style="display: none;">ออกจากระบบ</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- User Form View -->
        <div id="form-view">
            <div class="card"><div class="card-header fs-5"><i class="bi bi-pencil-square"></i> แบบฟอร์มแจ้งปัญหา</div><div class="card-body p-4"><form id="helpdesk-form"><div class="mb-3"><label for="submitterName" class="form-label fw-bold">ชื่อผู้แจ้ง</label><input type="text" class="form-control" id="submitterName" required></div><div class="mb-3"><label for="department" class="form-label fw-bold">แผนก / ฝ่าย</label><input type="text" class="form-control" id="department" required></div><div class="mb-3"><label for="problemType" class="form-label fw-bold">ประเภทปัญหา</label><select class="form-select" id="problemType" required><option selected disabled value="">-- กรุณาเลือก --</option><option>Hardware (อุปกรณ์คอมพิวเตอร์)</option><option>Software (โปรแกรม)</option><option>Network (ระบบเครือข่าย/อินเทอร์เน็ต)</option><option>Printer (เครื่องพิมพ์)</option><option>Other (อื่นๆ)</option></select></div><div class="mb-3"><label for="problemDetails" class="form-label fw-bold">รายละเอียดปัญหา</label><textarea class="form-control" id="problemDetails" rows="4" required></textarea></div><button type="submit" class="btn btn-primary w-100 py-2 fw-bold"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span> ส่งเรื่อง</button></form></div></div>
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-dashboard">
            <ul class="nav nav-pills admin-nav"><li class="nav-item"><a class="nav-link active" id="nav-tickets" href="#">รายการปัญหา</a></li><li class="nav-item"><a class="nav-link" id="nav-users" href="#">จัดการผู้ใช้</a></li></ul>
            <div id="admin-content">
                <div id="admin-view-tickets"><div class="card"><div class="card-header fs-5 d-flex justify-content-between align-items-center"><span><i class="bi bi-list-task"></i> รายการแจ้งปัญหาทั้งหมด</span><button id="refresh-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i></button></div><div class="card-body p-4"><div id="ticket-list"></div></div></div></div>
                <div id="admin-view-users" style="display: none;"><div class="card"><div class="card-header fs-5"><i class="bi bi-people"></i> จัดการผู้ใช้ระบบ</div><div class="card-body p-4"><div class="mb-4"><form id="add-user-form" class="row g-3 align-items-end"><div class="col-sm-4"><label for="newUsername" class="form-label">Username</label><input type="text" class="form-control" id="newUsername" required></div><div class="col-sm-4"><label for="newPassword" class="form-label">Password</label><input type="text" class="form-control" id="newPassword" required></div><div class="col-sm-4"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i> เพิ่มผู้ใช้</button></div></form><small id="user-limit-msg" class="form-text text-muted mt-2"></small></div><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Username</th><th>Password</th><th class="text-end">Actions</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div></div></div>
            </div>
        </div>
    </div>

    <!-- Modals and Spinner -->
    <div class="loading-spinner"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div></div>
    <div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="alertModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="alertModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button></div></div></div></div>
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">เจ้าหน้าที่ล็อกอิน</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="login-form"><div class="mb-3"><label for="adminUsernameInput" class="form-label">Username</label><input type="text" class="form-control" id="adminUsernameInput" required></div><div class="mb-3"><label for="adminPasswordInput" class="form-label">Password</label><input type="password" class="form-control" id="adminPasswordInput" required></div><div id="login-error" class="text-danger mt-2" style="display: none;">Username หรือ Password ไม่ถูกต้อง!</div><button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button></form></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ยืนยันการดำเนินการ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" id="confirmModalBtn">ยืนยัน</button></div></div></div></div>
    <div class="modal fade" id="editUserModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">แก้ไขข้อมูลผู้ใช้</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-user-form"><input type="hidden" id="editUserRowIndex"><div class="mb-3"><label for="editUsername" class="form-label">Username</label><input type="text" class="form-control" id="editUsername" required></div><div class="mb-3"><label for="editPassword" class="form-label">Password</label><input type="text" class="form-control" id="editPassword" required></div><button type="submit" class="btn btn-primary w-100">บันทึกการเปลี่ยนแปลง</button></form></div></div></div></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYKnFhgUsIQqj6B09f27eg210oIxy1rcmgX3atEU5_j5j2y8G0NrU9L1qKKEFPOlH-0Q/exec';
        
        // --- GLOBAL STATE ---
        let allTickets = [];
        let adminUsers = [];

        // --- DOM ELEMENTS ---
        const formView = document.getElementById('form-view');
        const adminDashboard = document.getElementById('admin-dashboard');
        const helpdeskForm = document.getElementById('helpdesk-form');
        const ticketList = document.getElementById('ticket-list');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingSpinner = document.querySelector('.loading-spinner');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userTableBody = document.getElementById('user-table-body');
        const addUserForm = document.getElementById('add-user-form');
        const userLimitMsg = document.getElementById('user-limit-msg');
        
        // Modals
        const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        const loginForm = document.getElementById('login-form');
        const editUserForm = document.getElementById('edit-user-form');
        let confirmCallback = null;

        // Admin Nav Elements
        const adminNavLinks = document.querySelectorAll('.admin-nav .nav-link');
        const adminContentPanes = document.querySelectorAll('#admin-content > div');

        // --- FUNCTIONS ---
        function showAlert(message, isSuccess = true) {
            document.getElementById('alertModalLabel').textContent = isSuccess ? 'สำเร็จ!' : 'เกิดข้อผิดพลาด';
            document.getElementById('alertModalBody').innerHTML = message;
            alertModal.show();
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmModalBody').textContent = message;
            confirmCallback = callback;
            confirmModal.show();
        }

        function showLoading(show) { loadingSpinner.style.display = show ? 'block' : 'none'; }
        
        function switchAdminView(targetId) {
            adminContentPanes.forEach(pane => { pane.style.display = pane.id === targetId ? 'block' : 'none'; });
            adminNavLinks.forEach(link => { link.classList.toggle('active', link.id === `nav-${targetId.split('-')[2]}`); });
        }

        async function postToAction(action, data) {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data })
                });
                // Assuming success due to no-cors. Refresh data to see changes.
                showAlert('ดำเนินการเรียบร้อย กำลังรีเฟรชข้อมูล...');
                setTimeout(fetchInitialData, 2000);
            } catch (error) {
                showAlert('เกิดข้อผิดพลาด: ' + error, false);
                showLoading(false);
            }
        }

        function renderTickets(tickets) {
            ticketList.innerHTML = '';
            if (!tickets || tickets.length === 0) {
                ticketList.innerHTML = '<p class="text-center text-muted">ยังไม่มีรายการแจ้งปัญหา</p>';
                return;
            }
            tickets.sort((a, b) => {
                if (a.Status === 'Open' && b.Status !== 'Open') return -1;
                if (a.Status !== 'Open' && b.Status === 'Open') return 1;
                return new Date(b.SubmissionTimestamp) - new Date(a.SubmissionTimestamp);
            });
            tickets.forEach(ticket => {
                const statusClass = ticket.Status === 'Open' ? 'bg-warning' : 'bg-success';
                ticketList.insertAdjacentHTML('beforeend', `<div class="card mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-start mb-2"><span class="ticket-id">${ticket.CaseID}</span><span class="badge rounded-pill status-badge ${statusClass}">${ticket.Status}</span></div><div class="ticket-details"><p><strong>ชื่อผู้แจ้ง:</strong> ${ticket.SubmitterName}</p><p><strong>แผนก/ฝ่าย:</strong> ${ticket.Department}</p><p><strong>ประเภท:</strong> ${ticket.ProblemType}</p><p><strong>รายละเอียด:</strong></p><p class="text-secondary" style="white-space: pre-wrap;">${ticket.ProblemDetails}</p></div><div class="ticket-footer small mt-3 pt-3 border-top border-secondary-subtle"><div class="row"><div class="col-md-6 mb-1 mb-md-0"><i class="bi bi-calendar-plus"></i> <strong>เวลาแจ้ง:</strong> ${ticket.SubmissionTimestamp || 'N/A'}</div><div class="col-md-6">${ticket.Status === 'Closed' ? `<i class="bi bi-calendar-check"></i> <strong>เวลาปิดเคส:</strong> ${ticket.ClosedTimestamp || 'N/A'}` : ''}</div></div></div>${ticket.Status === 'Open' ? `<div class="mt-3 text-end"><button class="btn btn-success btn-sm close-ticket-btn" data-row-index="${ticket.RowIndex}"><i class="bi bi-check-circle"></i> ปิดเคส</button></div>` : ''}</div></div>`);
            });
            document.querySelectorAll('.close-ticket-btn').forEach(b => b.addEventListener('click', e => postToAction('closeTicket', { rowIndex: e.target.closest('.close-ticket-btn').dataset.rowIndex })));
        }
        
        function renderUsers(users) {
            userTableBody.innerHTML = '';
            if (!users || users.length === 0) return;
            users.forEach(user => {
                userTableBody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.password}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-warning me-2 edit-user-btn" data-row-index="${user.rowIndex}" data-username="${user.username}" data-password="${user.password}"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-user-btn" data-row-index="${user.rowIndex}"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`);
            });
            
            const userCount = users.length;
            userLimitMsg.textContent = `จำนวนผู้ใช้: ${userCount}/5`;
            addUserForm.querySelector('button').disabled = userCount >= 5;
            
            document.querySelectorAll('.edit-user-btn').forEach(b => b.addEventListener('click', handleEditUserClick));
            document.querySelectorAll('.delete-user-btn').forEach(b => b.addEventListener('click', handleDeleteUserClick));
        }

        async function fetchInitialData() {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    allTickets = result.data.tickets || [];
                    adminUsers = result.data.users || [];
                    renderTickets(allTickets);
                    renderUsers(adminUsers);
                } else {
                    showAlert('ไม่สามารถโหลดข้อมูลได้: ' + (result.message || 'Unknown error'), false);
                }
            } catch (error) {
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error, false);
            } finally {
                showLoading(false);
            }
        }
        
        function handleEditUserClick(e) {
            const btn = e.target.closest('.edit-user-btn');
            document.getElementById('editUserRowIndex').value = btn.dataset.rowIndex;
            document.getElementById('editUsername').value = btn.dataset.username;
            document.getElementById('editPassword').value = btn.dataset.password;
            editUserModal.show();
        }
        
        function handleDeleteUserClick(e) {
            const btn = e.target.closest('.delete-user-btn');
            const rowIndex = btn.dataset.rowIndex;
            if (adminUsers.length <= 1) {
                showAlert('ไม่สามารถลบผู้ใช้คนสุดท้ายได้', false);
                return;
            }
            showConfirm('คุณต้องการลบผู้ใช้นี้ใช่หรือไม่?', () => postToAction('deleteUser', { rowIndex }));
        }

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', () => loginModal.show());
        
        logoutBtn.addEventListener('click', () => {
            adminDashboard.style.display = 'none';
            formView.style.display = 'block';
            logoutBtn.style.display = 'none';
            loginBtn.style.display = 'block';
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('adminUsernameInput').value;
            const password = document.getElementById('adminPasswordInput').value;
            const foundUser = adminUsers.find(user => user.username === username && user.password === password);

            if (foundUser) {
                loginModal.hide();
                formView.style.display = 'none';
                adminDashboard.style.display = 'block';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                switchAdminView('admin-view-tickets');
                loginForm.reset();
                document.getElementById('login-error').style.display = 'none';
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });

        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPaneId = `admin-view-${e.target.id.split('-')[1]}`;
                switchAdminView(targetPaneId);
            });
        });

        document.getElementById('confirmModalBtn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') confirmCallback();
            confirmModal.hide();
            confirmCallback = null;
        });

        refreshBtn.addEventListener('click', fetchInitialData);

        helpdeskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = {
                submitterName: document.getElementById('submitterName').value,
                department: document.getElementById('department').value,
                problemType: document.getElementById('problemType').value,
                problemDetails: document.getElementById('problemDetails').value
            };
            postToAction('submitTicket', formData).then(() => helpdeskForm.reset());
        });
        
        addUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value
            };
            postToAction('addUser', userData).then(() => addUserForm.reset());
        });
        
        editUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userData = {
                rowIndex: document.getElementById('editUserRowIndex').value,
                username: document.getElementById('editUsername').value,
                password: document.getElementById('editPassword').value
            };
            postToAction('editUser', userData).then(() => editUserModal.hide());
        });
        
        // Initial Load
        fetchInitialData();
    </script>
</body>
</html>
